# System Patterns

<!-- System architecture. Key technical decisions. Design patterns in use. Component relationships. -->

## 1. Overall Architecture: Static-First with Dynamic Enhancements
- **Core Principle**: The website is primarily a Static Site Generation (SSG) build using Astro. This prioritizes performance, SEO, and security by serving pre-rendered HTML.
- **Client-Side Interactivity ("Islands Architecture")**: Astro's "islands" architecture is used to hydrate interactive UI components on the client-side as needed. React (`.tsx`) components are primarily used for these islands (e.g., `src/components/mdx/react/`, `src/components/ui/tabs.tsx`, `TicketingButton.tsx`).
- **Data Sources**:
    - **NocoDB**: Main source for dynamic structured content like festival events, workshops, and stands. Accessed during build time.
    - **Git Repository (via TinaCMS)**: Content (blog posts, pages, configurations) is stored as Markdown, MDX, and JSON files directly in the `src/content/` directory and managed via Tina CMS.
    - **Local JSON/TS files**: `src/data/` and `src/config/` hold static or semi-static data.
- **Deployment Model**: Static files generated by `npm run build` are deployed to Netlify.

## 2. Component-Based Architecture
- **Astro Components (`.astro`)**: Form the backbone of the site structure, layouts, and most UI elements.
- **React Components (`.tsx`)**: Used for more complex client-side interactivity, often embedded within Astro components or MDX.
- **Directory Structure for Components** (as per `.cursorrules` and `tree` output in `src/components/`):
    - `common/`: Highly reusable, generic components (e.g., `Image.astro`, `Logo.astro`, `Analytics.astro`).
    - `features/`: Components specific to a larger feature set (structure not heavily populated in `tree` but a conceptual grouping).
    - `layouts/` (in `src/layouts/`): Page shell layouts (e.g., `Layout.astro`, `PageLayout.astro`, `MarkdownLayout.astro`).
    - `ui/`: Basic UI primitives (e.g., `Button.astro`, `Card.astro`, `Form.astro`, `Modal` (implied by `TicketingModal.astro`)).
    - `widgets/`: More complex, often self-contained UI blocks (e.g., `Header.astro`, `Footer.astro`, `CallToAction.astro`, `BlogLatestPosts.astro`).
    - `blog/`: Components specific to the blog functionality (e.g., `Grid.astro`, `ListItem.astro`, `Pagination.astro`).
    - `forms/`: Components related to form handling (e.g., `ProjectSubmissionForm.astro`).
    - `sections/`: Larger page sections, often composing multiple smaller components (e.g., `HeroSection.astro`, `NewsletterSection.astro`).
- **Naming Convention**: Components are named in PascalCase.
- **Props**: Clearly documented with TypeScript and JSDoc.

## 3. Routing and Page Generation
- **File-System Routing**: Astro uses a file-based routing system. Files in `src/pages/` map to site URLs.
    - Example: `src/pages/festival.astro` -> `outofthebooks.com/festival`.
- **Dynamic Routes**:
    - For blog posts, categories, and tags (e.g., `src/pages/[...blog]/[category]/[...page].astro`). Slugs are generated, likely from frontmatter or directory structure.
- **API Routes**: Server-side functions located in `src/pages/api/` (e.g., `src/pages/api/events.ts`). These can be used for tasks like handling form submissions or proxying requests, though with an SSG focus, their use might be for specific dynamic interactions or build-time data fetching support.
- **Layouts**: Astro layouts (`src/layouts/`) provide common page structure (HTML shell, headers, footers). Content pages and components are slotted into these layouts.

## 4. Data Flow & State Management
- **Build-Time Data Fetching**:
    - Scripts in `src/scripts/` (e.g., `build-festival-data.js`) fetch data from NocoDB.
    - Fetched data is processed and often stored as JSON files (e.g., in `src/content/festival/raw-data/`, `src/data/`) or directly consumed by Astro pages/components during the build.
    - `src/services/api/nocodb/` provides a structured way to interact with the NocoDB API. Cache mechanisms might be in place (`cache.ts`).
- **Static Content**: `.md`, `.mdx`, and `.json` files in `src/content/` are directly processed by Astro. TinaCMS allows editing this content.
- **Client-Side State**: Primarily managed within individual React components (`.tsx`). For more complex client-side state or data fetching (e.g., after initial page load), `src/providers/QueryProvider.tsx` suggests a library like React Query might be used.
- **Global State (Astro)**: Astro itself is not a state management library in the client-side sense. Global data is typically passed down through props or made available via context during build time.

## 5. Content & Asset Handling Patterns
- **Markdown/MDX for Rich Content**: `src/content/post/` uses `.mdx` extensively, allowing for rich text and embedded interactive React components.
- **JSON for Structured Data**: Configuration, festival data, and other structured content are often stored in `.json` files within `src/content/` and `src/config/`.
- **Image Handling**:
    - Centralized `Image.astro` component (`src/components/common/Image.astro`) for consistent image rendering, optimization, and accessibility.
    - Astro Assets for build-time optimization (resizing, format conversion).
    - Preferred formats: AVIF, WebP, with JPG/PNG as fallbacks.
    - Lazy loading and async decoding are standard.
    - Images organized in `src/assets/images/`.
- **Icon System**: Tabler Icons via `astro-icon/components`.

## 6. Performance & Accessibility Patterns
- **SSG Core**: Minimizes client-side JavaScript and delivers fast initial page loads.
- **Image Optimization**: Critical for performance (see Image Handling).
- **Code Splitting**: Astro automatically splits code for optimal loading.
- **Lazy Loading**: Implemented for images and potentially other off-screen content.
- **Accessibility (WCAG) Focused**:
    - Semantic HTML structure.
    - ARIA landmarks.
    - Color contrast requirements (min 4.5:1).
    - Keyboard navigation.
    - `prefers-reduced-motion` respected for animations.
- **EcoIndex Optimization Targets**:
    - DOM size < 800 nodes.
    - HTTP requests < 40.
    - Resource weight < 500KB per page.
- **Lighthouse Score Target**: >90 across all categories.

## 7. Configuration Management
- **Project Configuration**: `src/config/` directory for TypeScript-based configurations (e.g., `festival.ts`, `nocodb.ts`).
- **Site-wide Settings**: `src/content/site/settings.json` for general site settings, potentially used by TinaCMS or global components.
- **Astro Configuration**: `astro.config.mjs` (not in `src/` but at project root) defines Astro integrations, output modes, etc.
- **Environment Variables**: Handled by Netlify for deployment, documented in `README.md`.

## 8. Modularity and Reusability
- **Component-Driven**: High degree of modularity achieved through Astro and React components.
- **Utility Functions**: `src/lib/` and `src/utils/` house reusable functions for tasks like post handling (`posts.ts`), image processing, and general utilities.
- **Service Layer**: `src/services/` abstracts external API interactions (e.g., NocoDB).
- **Type Definitions**: `src/types/` ensures consistency and clear contracts between modules.

## 9. API Integrations
- **NocoDB**: Primary backend for structured data (events, etc.), accessed via a dedicated service layer.
- **TinaCMS**: Integrates with the Git repository for content editing.
- **Cloudinary**: Media asset storage and delivery, likely integrated with TinaCMS.
- **Brevo**: Email services.
- **Supabase**: `src/lib/supabase.ts` file exists; however, Supabase is **not currently in active use** according to project owner. Its presence might indicate past consideration or future plans. 