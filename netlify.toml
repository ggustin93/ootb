[build]
  publish = "dist"
  command = "npm run build"

[dev]
  command = "npm run dev"
  port = 3000
  targetPort = 4321
  framework = "astro"

# [functions]
#   node_bundler = "esbuild"

# Variables d'environnement pour le développement local
# Pour la production, configurez-les dans l'interface Netlify
# [build.environment]
#   GITHUB_OWNER = ""
#   GITHUB_REPO = ""
#   GITHUB_TOKEN = ""
#   GITHUB_BRANCH = "main"
#   TRIGGER_NETLIFY_BUILD = "false"
#   NETLIFY_BUILD_HOOK = ""

# Configuration pour la fonction submit-pedagogical-sheet
[[redirects]]
  from = "/api/submit-pedagogical-sheet"
  to = "/.netlify/functions/submit-pedagogical-sheet"
  status = 200
  force = true

# Configuration pour la fonction submit-newsletter
[[redirects]]
  from = "/api/submit-newsletter"
  to = "/.netlify/functions/submit-newsletter"
  status = 200
  force = true

# Configuration pour la fonction submit-contact
[[redirects]]
  from = "/api/submit-contact"
  to = "/.netlify/functions/submit-contact"
  status = 200
  force = true

[build.environment]
  NODE_VERSION = "20.11.0"
  SHARP_IGNORE_GLOBAL_LIBVIPS = "1"
  NETLIFY = "true"
  # Optimisations de cache pour réduire le temps de build
  NETLIFY_USE_YARN_CACHE = "true"
  NETLIFY_CACHE_FOLDER = ".cache"
  # Optimisations de performance
  NODE_OPTIONS = "--max-old-space-size=4096"

# Configuration du cache pour les assets statiques
[[headers]]
  for = "/_astro/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[redirects]]
  from = "/admin"
  to = "https://outofthebooks.vercel.app/admin"
  status = 301
  force = true

[[redirects]]
  from = "/admin/*"
  to = "https://outofthebooks.vercel.app/admin/:splat"
  status = 301
  force = true

# Compression Brotli pour une meilleure performance
[build.processing]
  skip_processing = false
[build.processing.css]
  bundle = true
  minify = true
[build.processing.js]
  bundle = true
  minify = true
[build.processing.html]
  pretty_urls = true
[build.processing.images]
  compress = true

# Redirection pour la déconnexion
[[redirects]]
  from = "/api/auth/logout"
  to = "/.netlify/functions/auth/logout"
  status = 200
  force = true

# Middleware pour protéger les routes du tableau de bord
[[redirects]]
  from = "/dashboard/*"
  to = "/.netlify/functions/auth-middleware"
  status = 200
  force = true
  conditions = {Role = ["admin"]}

# Redirection après vérification du middleware
[[redirects]]
  from = "/dashboard/*"
  to = "/dashboard/:splat"
  status = 200
  force = true